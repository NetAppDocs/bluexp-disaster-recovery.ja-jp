---
sidebar: sidebar 
permalink: use/drplan-create.html 
keywords: disaster recovery, bluexp disaster recovery, failover, failback, replicate, fail over, fail back, vmware, vcenter, replication plan, protection, disaster, recovery, virtual machines, vm 
summary: NetApp BlueXPディザスタリカバリは、ディザスタリカバリのワークフローを自動化するクラウドベースのディザスタリカバリサービスです。vCenterサイトを追加したら、ディザスタリカバリまたはレプリケーションの計画を作成できます。 
---
= BlueXP災害復旧でレプリケーションプランを作成する
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/use/


[role="lead"]
vCenterサイトを追加したら、ディザスタリカバリ（_replication plan_）を作成できます。ソースvCenterとデスティネーションvCenterを選択し、リソースグループを選択して、アプリケーションのリストア方法とパワーオン方法をグループ化します。たとえば、1つのアプリケーションに関連付けられた仮想マシン（VM）をグループ化したり、同様の階層を持つアプリケーションをグループ化したりできます。

このような計画は、_ blueprints _と呼ばれることもあります。

レプリケーション計画を作成し、コンプライアンスとテストのスケジュールを編集することもできます。

複数のデータストア上の複数のVMを保護できます。BlueXP  ディザスタリカバリでは、保護対象のVMデータストアをホストするすべてのONTAPボリュームに対してONTAP整合性グループが作成されます。

VMを保護できるのは、レプリケーションプランが次のいずれかの状態にある場合のみです。

* 準備完了
* フェイルバックコミット済み
* テストフェイルオーバーコミット済み




== 計画の作成

ウィザードでは、次の手順を実行します。

* [vCenter Server]を選択します。
* レプリケートするVMまたはデータストアを選択し、リソースグループを割り当てます。
* ソース環境のリソースをデスティネーションにマッピングします。
* 繰り返し発生する問題を特定し、ゲストホストスクリプトを実行し、ブート順序を設定して、目標復旧時点を選択します。
* 計画をレビューします。


計画を作成するときは、次のガイドラインに従ってください。

* プラン内のすべてのVMに同じクレデンシャルを使用します。
* 計画内のすべてのVMに同じスクリプトを使用します。
* 計画内のすべてのVMに同じサブネット、DNS、およびゲートウェイを使用します。


.作業を開始する前に
このサービスでSnapMirror関係を作成する場合は、クラスタとそのSVMピアリングがBlueXPディザスタリカバリ以外ですでにセットアップされている必要があります。



=== vCenterサーバを選択

最初にソースvCenterを選択し、次にデスティネーションvCenterを選択します。

.手順
. BlueXPの左側のナビゲーションで、*[保護]*>*[ディザスタリカバリ]*を選択します。
. BlueXP  ディザスタリカバリのトップメニューで、*[レプリケーションプラン]*を選択し、*[追加]*を選択します。または、サービスの使用を開始したばかりの場合は、ダッシュボードで*[レプリケーションプランの追加]*を選択します。
+
image:dr-plan-create-name.png["Add replication plan  gt; Add planページのスクリーンショット"]

. レプリケーションプランの名前を作成します。
. ソースvCenterとターゲットvCenterのリストから、ソースvCenterとターゲットvCenterを選択します。
. 「 * 次へ * 」を選択します。




=== レプリケートするアプリケーションの選択とリソースグループの割り当て

次の手順では、必要なVMまたはデータストアを機能するリソースグループにグループ化します。リソースグループを使用すると、共通のSnapshotで一連のVMまたはデータストアを保護できます。

レプリケーションプランでアプリケーションを選択すると、プラン内の各VMまたはデータストアのオペレーティングシステムが表示されます。これは、VMまたはデータストアを1つのリソースグループにグループ化する方法を決定する際に役立ちます。


TIP: 各リソースグループには1つ以上のVMまたはデータストアを含めることができます。

リソースグループを作成するときは、次の点を考慮してください。

* リソースグループにデータストアを追加する前に、最初にVMの手動検出またはスケジュールされた検出を開始してください。これにより、VMが検出されてリソースグループにリストされます。手動検出をトリガーしないと、VMがリソースグループに表示されない可能性があります。
* データストアにVMが少なくとも1つあることを確認します。データストアにVMがない場合、データストアは検出されません。
* 1つのデータストアで複数のレプリケーションプランで保護されているVMをホストしないでください。
* 保護されているVMと保護されていないVMを同じデータストアでホストしないでください。保護されているVMと保護されていないVMが同じデータストアでホストされている場合、次の問題が発生する可能性があります。
+
** BlueXP  ディザスタリカバリではSnapMirrorを使用し、システムはONTAPボリューム全体をレプリケートするため、そのボリュームの使用容量はライセンスに関する考慮事項として使用されます。この場合、保護されているVMと保護されていないVMの両方で消費されるボリュームスペースがこの計算に含まれます。
** リソースグループと関連するデータストアをディザスタリカバリサイトにフェイルオーバーする必要がある場合は、フェイルオーバープロセスによって保護されていないVM（リソースグループに含まれていないがONTAPボリュームでホストされているVM）がソースサイトに存在しなくなり、ソースサイトで保護されていないVMで障害が発生します。また、BlueXP  ディザスタリカバリでは、保護されていないVMはフェイルオーバーvCenterサイトで開始されません。


* VMを保護するには、そのVMをリソースグループに含める必要があります。


*ベストプラクティス*：BlueXP  ディザスタリカバリを導入する前にVMを整理し、「データストアの無秩序な増加」を最小限に抑えます。保護が必要なVMは一部のデータストアに配置し、保護されないVMは別のデータストアに配置します。データストアベースの保護を使用して、特定のデータストア上のVMを確実に保護します。

.手順
. [仮想マシン]または*[データストア]*を選択します。
. 必要に応じて、特定のVMまたはデータストアを名前で検索します。
. [Applications]ページの左側で、保護するVMまたはデータストアを選択し、選択したグループに割り当てます。
+
選択したリソースが自動的にグループ1に追加され、新しいグループ2が開始されます。最後のグループにリソースを追加するたびに、別のグループが追加されます。

+
image:dr-plan-create-apps-vms6.png["[Add replication plan  gt; Applications to replicate]ページのスクリーンショット"]

+
または、データストアの場合：

+
image:dr-plan-create-apps-datastores.png["[Add replication plan  gt; Applications to replicate]ページのスクリーンショット"]

. 必要に応じて、次のいずれかを実行します。
+
** グループ名を変更するには、グループ*[編集]*アイコンをクリックしimage:icon-pencil.png["鉛筆のアイコン"]ます。
** グループからリソースを削除するには、リソースの横にある* X *を選択します。
** リソースを別のグループに移動するには、新しいグループにドラッグアンドドロップします。
+

TIP: データストアを別のリソースグループに移動するには、不要なデータストアの選択を解除し、レプリケーション計画を送信します。次に、他のレプリケーションプランを作成または編集し、データストアを再度選択します。



. 「 * 次へ * 」を選択します。




=== ソースリソースをターゲットにマッピング

リソースマッピングステップで、ソース環境のリソースをターゲットにマッピングする方法を指定します。レプリケーションプランを作成するときに、プラン内のVMごとにブート遅延と順序を設定できます。これにより、VMの起動順序を設定できます。

.作業を開始する前に
このサービスでSnapMirror関係を作成する場合は、クラスタとそのSVMピアリングがBlueXPディザスタリカバリ以外ですでにセットアップされている必要があります。

.手順
. [Resource mapping]ページで、フェールオーバー操作とテスト操作の両方に同じマッピングを使用するには、チェックボックスをオンにします。
+
image:dr-plan-resource-mapping2.png["レプリケーションプランの[リソースマッピング]タブ"]

. [Failover mappings]タブで、各リソースの右側にある下向き矢印を選択し、それぞれのリソースをマッピングします。




=== リソースをマッピング>[Compute resources]セクション

[Compute resources]*の横にある下矢印を選択します。

* *ソースとターゲットのデータセンター*
* *ターゲットクラスタ*
* *ターゲットホスト*（オプション）：クラスタを選択したら、この情報を設定できます。



TIP: vCenterでクラスタ内の複数のホストを管理するようにDistributed Resource Scheduler（DRS；分散リソーススケジューラ）が設定されている場合は、ホストを選択する必要はありません。ホストを選択すると、BlueXP  ディザスタリカバリによって、選択したホストにすべてのVMが配置されます。**ターゲットVMフォルダ*（オプション）：選択したVMを格納する新しいルートフォルダを作成します。



=== [リソースのマッピング]>[仮想ネットワーク]セクション

[フェイルオーバーマッピング]タブで、*[仮想ネットワーク]*の横にある下矢印を選択します。ソース仮想LANとターゲット仮想LANを選択します。

適切な仮想LANへのネットワークマッピングを選択します。仮想LANはすでにプロビジョニングされているので、適切な仮想LANを選択してVMをマッピングします。



=== [リソースのマッピング]>[仮想マシン]セクション

[フェイルオーバーマッピング]タブで、*[仮想マシン]*の横にある下矢印を選択します。

VMのデフォルトはマッピングされています。デフォルトのマッピングでは、VMが本番環境で使用するのと同じ設定（同じIPアドレス、サブネットマスク、およびゲートウェイ）が使用されます。

デフォルト設定から変更を加えた場合は、[Target IP]フィールドを[different from source]に変更する必要があります。


NOTE: 設定を「ソースと異なる」に変更する場合は、VMゲストOSのクレデンシャルを指定する必要があります。

このセクションには、選択内容によって異なるフィールドが表示される場合があります。

* * IPアドレスタイプ*：ターゲットの仮想ネットワーク要件に合わせて、VMS構成を再設定します。BlueXP  ディザスタリカバリには、DHCPと静的IPの2つのオプションがあります。スタティックIPの場合は、サブネットマスク、ゲートウェイ、およびDNSサーバを設定します。さらに、VMのクレデンシャルを入力します。
+
** * DHCP *：VMがDHCPサーバからネットワーク構成情報を取得するようにする場合は、この設定を選択します。このオプションを選択する場合は、VMのクレデンシャルだけを指定します。
** *静的IP *：IP構成情報を手動で指定する場合は、この設定を選択します。ソースと同じ、ソースと異なる、またはサブネットマッピングのいずれかを選択できます。ソースと同じを選択した場合は、クレデンシャルを入力する必要はありません。一方、ソースと異なる情報を使用する場合は、クレデンシャル、VMのIPアドレス、サブネットマスク、DNS、およびゲートウェイ情報を指定できます。VMゲストOSのクレデンシャルは、グローバルレベルまたは各VMレベルで指定する必要があります。
+
これは、大規模な環境を小規模なターゲットクラスタにリカバリする場合や、1対1の物理VMwareインフラストラクチャをプロビジョニングせずにディザスタリカバリテストを実行する場合に非常に役立ちます。

+
image:dr-plan-vm-subnet-option2.png["レプリケーションプランの追加>リソースマッピング>仮想マシンを示すスクリーンショット"]



* *ターゲット IP* フィールドで、次のいずれかを選択します。
+
** *ソースと同じ*
** *ソースと異なります*
** *サブネットマッピング*: ソースサブネットを別のターゲットサブネットにマッピングする場合は、このオプションを選択します。ソースサブネットを選択してから、ターゲットサブネットを選択できます。これは、ターゲット環境のVMのIPアドレスを変更する場合に便利です。
+

NOTE: サブネット マッピングの使用は、オプションの 2 段階のプロセスです。まず、[サイト] タブで各 vCenter サイトのサブネット マッピングを追加します。次に、レプリケーション計画でサブネットマッピングを使用することを指定します。

+

NOTE: VMが2つある場合（1つがLinux、もう1つがWindowsなど）、クレデンシャルはWindowsの場合にのみ必要です。



* *Windows LAPSを使用する*：Windows Local Administrator Password Solution（Windows LAPS）を使用している場合は、このチェックボックスをオンにしてください。このオプションは、*静的IP*オプションを選択した場合にのみ使用できます。このチェックボックスをオンにすると、仮想マシンごとにパスワードを入力する必要がなくなります。代わりに、ドメインコントローラの詳細を入力します。
+
Windows LAPS を使用しない場合、VM は Windows VM であり、VM 行の資格情報オプションが有効になっています。VMの資格情報を指定できます。

* *スクリプト*:フェイルオーバー後のプロセスとして、.sh、.bat、または.ps1形式のカスタムスクリプトを含めることができます。カスタムスクリプトを使用すると、フェイルオーバープロセスのあとにBlueXPディザスタリカバリでスクリプトを実行できます。たとえば、フェイルオーバーの完了後にすべてのデータベーストランザクションを再開するカスタムスクリプトを使用できます。
* *ターゲットVMのプレフィックスとサフィックス*：仮想マシンの詳細で、必要に応じてVM名にプレフィックスとサフィックスを追加できます。
* *ソースVMのCPUとRAM *：仮想マシンの詳細で、必要に応じてVMのCPUとRAMのパラメータのサイズを変更できます。
+
image:dr-plan-resource-mapping-vm-boot-order.png["レプリケーションプランの追加>リソースマッピング>仮想マシンを示すスクリーンショット"]

* *起動順序*：リソースグループ全体で選択したすべての仮想マシンのフェイルオーバー後に起動順序を変更できます。デフォルトでは、すべてのVMが同時に並行して起動されますが、この段階で変更を加えることができます。これは、優先順位の高いすべてのVMが実行されてから、優先順位の高いVMが起動されるようにするのに役立ちます。
+
同じブート順序番号のVMは、並行してブートされます。

+
** シーケンシャルブート：各VMに一意の番号を割り当てて、割り当てられた順序でをブートします（例：1、2、3、4、5）。
** 同時起動：1、1、1、1、2、3、4など、すべてのVMに同じ番号を割り当てて同時に起動します。


* *起動遅延*：起動動作の遅延を分単位で調整します。
+

TIP: 起動順序をデフォルトにリセットするには、* VM設定をデフォルトにリセット*を選択し、どの設定をデフォルトに戻すかを選択します。

* *アプリケーションと整合性のあるレプリカを作成*：アプリケーションと整合性のあるSnapshotコピーを作成するかどうかを指定します。サービスはアプリケーションを休止し、スナップショットを作成してアプリケーションの整合性のある状態を取得します。この機能は、WindowsおよびLinuxで実行されているOracleおよびWindowsで実行されているSQL Serverでサポートされています。




=== リソースのマッピング>[Datastores]セクション

[データストア]*の横にある下矢印を選択します。VMを選択すると、データストアマッピングが自動的に選択されます。

このセクションは、選択内容に応じて有効または無効にすることができます。

image:dr-plan-datastore-platform.png["レプリケーションプランの追加>リソースマッピング>データストアのスクリーンショット"]

* *プラットフォームで管理されるバックアップと保持スケジュールを使用*：外部スナップショット管理ソリューションを使用している場合は、このチェックボックスをオンにします。BlueXP  のディザスタリカバリでは、標準のONTAP SnapMirrorポリシースケジューラやサードパーティの統合など、外部のSnapshot管理ソリューションを使用できます。レプリケーションプラン内のすべてのデータストア（ボリューム）にすでに別の場所で管理されているSnapMirror関係がある場合は、それらのSnapshotをBlueXP  ディザスタリカバリのリカバリポイントとして使用できます。
+
このオプションを選択すると、BlueXP  ディザスタリカバリでバックアップスケジュールが設定されません。ただし、テスト、フェイルオーバー、フェイルバック操作のためにスナップショットが作成される可能性があるため、保持スケジュールを設定する必要があります。

+
この設定後、サービスは定期的にスケジュールされたスナップショットを作成せず、代わりに外部エンティティに依存してこれらのスナップショットを作成および更新します。

* *開始時刻*：バックアップと保持の実行を開始する日時を入力します。
* *実行間隔*：時間間隔を時間と分で入力します。たとえば、1時間と入力すると、サービスは1時間ごとにスナップショットを作成します。
* *保持数*：保持するSnapshotの数を入力します。
* *ソースデータストアとターゲットデータストア*：（ファンアウト）SnapMirror関係が複数ある場合は、使用するデスティネーションを選択できます。ボリュームでSnapMirror関係がすでに確立されている場合は、対応するソースとターゲットのデータストアが表示されます。SnapMirror関係がないボリュームの場合は、ターゲットクラスタを選択し、ターゲットSVMを選択し、ボリューム名を指定して作成できます。ボリュームとSnapMirrorの関係が作成されます。
+

NOTE: このサービスでSnapMirror関係を作成する場合は、クラスタとそのSVMピアリングがBlueXPディザスタリカバリ以外ですでにセットアップされている必要があります。

+
** VMが同じボリュームと同じSVMの場合、サービスは標準のONTAPスナップショットを実行し、セカンダリデスティネーションを更新します。
** VMが別 々 のボリュームと同じSVMの場合は、すべてのボリュームを含めることで整合性グループSnapshotが作成され、セカンダリデスティネーションが更新されます。
** VMが別 々 のボリュームと別 々 のSVMにある場合、サービスは整合性グループの開始フェーズとコミットフェーズのSnapshotを実行します。これには、同じクラスタまたは別 々 のクラスタ内のすべてのボリュームが含まれ、セカンダリデスティネーションが更新されます。
** フェイルオーバー中は任意のSnapshotを選択できます。最新のスナップショットを選択すると、オンデマンドバックアップが作成され、デスティネーションが更新され、そのスナップショットがフェイルオーバーに使用されます。






=== テストフェイルオーバーマッピングを追加します。

.手順
. テスト環境に異なるマッピングを設定するには、チェックボックスをオフにして*テストマッピング*タブを選択します。
. 前のように各タブを確認しますが、今回はテスト環境について説明します。
+
[Test mappings]タブで、[Virtual Machines]と[Datastores]のマッピングが無効になります。

+

TIP: 後で計画全体をテストできます。ここでは、テスト環境用のマッピングを設定します。





=== レプリケーション計画のレビュー

最後に、レプリケーション計画を確認します。


TIP: レプリケーションプランは、あとで無効にしたり削除したりできます。

.手順
. [Plan Details]、[Failover Mapping]、[VMs]の各タブで情報を確認します。
. [プランの追加]*を選択します。
+
計画が計画のリストに追加されます。





== スケジュールを編集してコンプライアンスをテストし、フェイルオーバーテストが機能することを確認

コンプライアンスおよびフェイルオーバーテストをテストするスケジュールを設定して、必要に応じて正しく動作することを確認できます。

* *コンプライアンス時間への影響*：レプリケーション計画が作成されると、サービスはデフォルトでコンプライアンススケジュールを作成します。デフォルトの準拠時間は30分です。この時間を変更するには、レプリケーションプランのスケジュールの編集を使用します。
* *フェイルオーバーの影響をテスト*：フェイルオーバープロセスをオンデマンドでテストすることも、スケジュールに従ってテストすることもできます。これにより、レプリケーション計画で指定されたデスティネーションへの仮想マシンのフェイルオーバーをテストできます。
+
テストフェイルオーバーでは、FlexCloneボリュームを作成し、データストアをマウントして、そのデータストアのワークロードを移動します。テストフェイルオーバー処理では、本番環境のワークロード、テストサイトで使用されているSnapMirror関係、および正常に動作し続ける必要がある保護対象のワークロードに_not_の影響があります。



スケジュールに基づいてフェイルオーバーテストが実行され、レプリケーション計画で指定されたデスティネーションにワークロードが移動していることが確認されます。

.手順
. BlueXPディザスタリカバリのトップメニューで、*[レプリケーションプラン]*を選択します。
+
image:dr-plan-list.png["レプリケーションプランのリストを示すスクリーンショット"]

. [アクション]*を選択します。 image:icon-horizontal-dots.png["水平ドット[アクション]メニュー"] アイコンをクリックし、*[スケジュールの編集]*を選択します。
. BlueXPディザスタリカバリでテストへの準拠をチェックする頻度を分単位で入力します。
. フェイルオーバーテストに問題がないことを確認するには、*[毎月のスケジュールでフェイルオーバーを実行する]*をオンにします。
+
.. テストを実行する日にちと時刻を選択します。
.. テストを開始する日付をyyyy-mm-dd形式で入力します。
+
image:dr-plan-schedule-edit2.png["スケジュールを編集できる場所を示すスクリーンショット"]



. *スケジュールされたテストフェイルオーバーにオンデマンドスナップショットを使用*：自動テストフェイルオーバーを開始する前に新しいスナップショットを作成するには、このチェックボックスをオンにします。
. フェイルオーバーテストの完了後にテスト環境をクリーンアップするには、*[Automatically clean up after test failover]*をオンにし、クリーンアップを開始するまでの待機時間（分）を入力します。
+

NOTE: このプロセスでは、テスト用の場所から一時VMの登録が解除され、作成されたFlexCloneボリュームが削除され、一時データストアがアンマウントされます。

. [ 保存（ Save ） ] を選択します。

